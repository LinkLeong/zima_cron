const API_BASE=(window.API_BASE||'').replace(/\/$/,'');let tasks=[];const i18n={zh:{title:'定时管理器',header:'定时管理器',lang:'语言',taskList:'任务列表',runAll:'全部运行一次',newTask:'新建任务',colName:'名称',colCmd:'命令',colStatus:'状态',colNext:'下次执行',colLast:'上次结果',colActions:'操作',createTitle:'创建任务',name:'任务名称',cmd:'执行命令',plan:'计划类型',optInterval:'间隔分钟',optCron:'cron 表达式',interval:'执行间隔（分钟）',cron:'cron 表达式',cancel:'取消',create:'创建',phName:'例如：每日备份',phCmd:'例如：bash /path/to/script.sh',phInterval:'例如：60',phCron:'例如：*/5 * * * *',statusRunning:'运行中',statusPaused:'已暂停',btnRun:'运行一次',btnPause:'暂停',btnResume:'恢复',btnLogsShow:'查看日志',btnLogsHide:'隐藏日志',logsTitle:'日志 · ',btnClearLogs:'清空日志',btnDelete:'删除任务'},en:{title:'Scheduler',header:'Scheduler',lang:'Language',taskList:'Tasks',runAll:'Run All Once',newTask:'New Task',colName:'Name',colCmd:'Command',colStatus:'Status',colNext:'Next Run',colLast:'Last Result',colActions:'Actions',createTitle:'Create Task',name:'Task Name',cmd:'Command',plan:'Schedule Type',optInterval:'Interval (minutes)',optCron:'Cron Expression',interval:'Interval (minutes)',cron:'Cron Expression',cancel:'Cancel',create:'Create',phName:'e.g. Daily Backup',phCmd:'e.g. bash /path/to/script.sh',phInterval:'e.g. 60',phCron:'e.g. */5 * * * *',statusRunning:'Running',statusPaused:'Paused',btnRun:'Run Once',btnPause:'Pause',btnResume:'Resume',btnLogsShow:'Show Logs',btnLogsHide:'Hide Logs',logsTitle:'Logs · ',btnClearLogs:'Clear Logs',btnDelete:'Delete Task'}};let lang='en';function byId(id){return document.getElementById(id)}function fmtTime(ts){if(!ts)return '-';const d=new Date(ts);const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`}function escapeHtml(str){return str.replace(/[&<>"]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]))}function isValidCron(expr){return expr.trim().split(/\s+/).length===5}
function applyI18n(){const t=i18n[lang];if(t.wordSuccess===undefined){t.wordSuccess='Success'}if(t.wordFail===undefined){t.wordFail='Fail'}document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');if(t[k])el.textContent=t[k]});document.querySelectorAll('[data-i18n-ph]').forEach(el=>{const k=el.getAttribute('data-i18n-ph');if(t[k])el.setAttribute('placeholder',t[k])});document.querySelectorAll('[data-i18n-opt]').forEach(el=>{const k=el.getAttribute('data-i18n-opt');if(t[k])el.textContent=t[k]});document.title=t.title}
function init(){const modal=byId('createTaskModal');const openBtn=byId('openCreateModalBtn');const cancelBtn=byId('cancelCreateBtn');const createBtn=byId('createTaskBtn');const scheduleTypeSelect=byId('scheduleTypeSelect');const rowInterval=byId('rowInterval');const rowCron=byId('rowCron');const langSelect=byId('langSelect');lang='en';langSelect.value=lang;applyI18n();function openCreate(){modal.classList.add('show')}function closeCreate(){modal.classList.remove('show')}function updateVisibility(){const t=scheduleTypeSelect.value;if(t==='cron'){rowInterval.classList.add('hidden');rowCron.classList.remove('hidden')}else{rowInterval.classList.remove('hidden');rowCron.classList.add('hidden')}}openBtn.addEventListener('click',openCreate);cancelBtn.addEventListener('click',closeCreate);createBtn.addEventListener('click',()=>{createTask().then(closeCreate)});byId('runAllBtn').addEventListener('click',runAllOnce);scheduleTypeSelect.addEventListener('change',updateVisibility);langSelect.addEventListener('change',()=>{lang=langSelect.value;applyI18n();renderTasks()});updateVisibility();fetchTasks()}
async function fetchTasks(){const res=await fetch(`${API_BASE}/zima_cron/tasks`);const list=await res.json();const normalize=t=>({id:t.id,name:t.name,command:t.command,type:t.type,status:t.status,nextRunAt:t.next_run_at||0,lastRunAt:t.last_run_at||0,lastResult:t.last_result||null,showLogs:false,logs:[]});tasks=list.map(normalize);renderTasks()}
async function createTask(){const name=byId('taskNameInput').value.trim();const command=byId('commandInput').value.trim();const scheduleType=byId('scheduleTypeSelect').value;const intervalMin=parseInt(byId('intervalInput').value,10);const cronExpr=byId('cronInput').value.trim();if(!name||!command)return;if(scheduleType==='interval'){if(!intervalMin||intervalMin<1)return}else{if(!isValidCron(cronExpr))return}const payload={name,command,type:scheduleType,interval_min:intervalMin,cron_expr:cronExpr};await fetch(`${API_BASE}/zima_cron/tasks`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});byId('taskNameInput').value='';byId('commandInput').value='';byId('intervalInput').value='';byId('cronInput').value='';await fetchTasks()}
function renderTasks(){const tdict=i18n[lang];const tbody=byId('taskTableBody');tbody.innerHTML='';tasks.forEach(t=>{const tr=document.createElement('tr');const statusDot=`<span class="dot ${t.status}"></span>`;const statusText=t.status==='running'?tdict.statusRunning:tdict.statusPaused;const lastBadge=t.lastResult?`<span class="result-badge"><span class="dot ${t.lastResult.success?'success':'fail'}"></span>${t.lastResult.success?tdict.wordSuccess:tdict.wordFail}</span>`:'<span class="muted">-</span>';tr.innerHTML=`
      <td>${t.name}</td>
      <td><code>${escapeHtml(t.command)}</code></td>
      <td><span class="status">${statusDot}${statusText}</span></td>
      <td>${fmtTime(t.nextRunAt)}</td>
      <td>${lastBadge}</td>
      <td class="actions">
        <button data-action="run" data-id="${t.id}">${tdict.btnRun}</button>
        <button data-action="toggle" data-id="${t.id}">${t.status==='running'?tdict.btnPause:tdict.btnResume}</button>
        <button data-action="logs" data-id="${t.id}">${t.showLogs?tdict.btnLogsHide:tdict.btnLogsShow}</button>
        <button data-action="delete" data-id="${t.id}">${tdict.btnDelete}</button>
      </td>`;tbody.appendChild(tr);const logsRow=document.createElement('tr');const logsTd=document.createElement('td');logsTd.colSpan=6;if(t.showLogs){const header=document.createElement('div');header.className='logs-header';header.innerHTML=`<div class="muted">${tdict.logsTitle}${t.name}</div><div class="list-actions"><button data-action="clear-logs" data-id="${t.id}">${tdict.btnClearLogs}</button></div>`;const list=document.createElement('div');list.className='logs-list';(t.logs||[]).slice(0,100).forEach(l=>{const item=document.createElement('div');item.className='log-item';const statusClass=l.success?'success':'fail';item.innerHTML=`<div class="log-time">${fmtTime(l.time)}</div><div>${escapeHtml(l.message)}</div><div class="log-status ${statusClass}">${l.success?tdict.wordSuccess:tdict.wordFail}</div>`;list.appendChild(item)});const container=document.createElement('div');container.className='row-logs';container.appendChild(header);container.appendChild(list);logsTd.appendChild(container)}logsRow.appendChild(logsTd);tbody.appendChild(logsRow)});tbody.querySelectorAll('button').forEach(btn=>btn.addEventListener('click',onRowAction))}
function onRowAction(e){const action=e.currentTarget.getAttribute('data-action');const id=e.currentTarget.getAttribute('data-id');const task=tasks.find(t=>t.id===id);if(!task)return;if(action==='run')fetch(`${API_BASE}/zima_cron/tasks/${id}/run`,{method:'POST'}).then(fetchTasks);if(action==='toggle')fetch(`${API_BASE}/zima_cron/tasks/${id}/toggle`,{method:'POST'}).then(fetchTasks);if(action==='logs'){task.showLogs=!task.showLogs;if(task.showLogs){fetch(`${API_BASE}/zima_cron/tasks/${id}/logs`).then(r=>r.json()).then(d=>{task.logs=d;renderTasks()})}else{renderTasks()}}if(action==='clear-logs'){fetch(`${API_BASE}/zima_cron/tasks/${id}/logs/clear`,{method:'POST'}).then(()=>{task.logs=[];renderTasks()})}if(action==='delete'){fetch(`${API_BASE}/zima_cron/tasks/${id}`,{method:'DELETE'}).then(fetchTasks)}}
function runAllOnce(){const running=tasks.filter(t=>t.status==='running');Promise.all(running.map(t=>fetch(`${API_BASE}/zima_cron/tasks/${t.id}/run`,{method:'POST'}))).then(fetchTasks)}
document.addEventListener('DOMContentLoaded',init)
